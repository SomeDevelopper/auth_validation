<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion Faciale</title>
    <style>
        #videoSection {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Connexion par Reconnaissance Faciale</h2>

    <form id="loginForm">
        <label for="nom">Nom :</label>
        <input type="text" id="nom" name="nom" required><br><br>

        <label for="prenom">Pr√©nom :</label>
        <input type="text" id="prenom" name="prenom" required><br><br>

        <button type="submit">D√©marrer la d√©tection</button>
    </form>

    <div id="videoSection">
        <h3>üîç Analyse faciale en cours...</h3>
        <video id="video" autoplay></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <p id="status">üì° Surveillance en cours...</p>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const videoSection = document.getElementById('videoSection');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusText = document.getElementById('status');

        let nom = "";
        let prenom = "";

        loginForm.addEventListener('submit', function (e) {
            e.preventDefault();
            nom = document.getElementById('nom').value;
            prenom = document.getElementById('prenom').value;

            videoSection.style.display = 'block';
            loginForm.style.display = 'none';

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    setTimeout(captureAndSend, 3000); // Commencer apr√®s 3s
                })
                .catch(err => {
                    console.error("Erreur d'acc√®s √† la cam√©ra :", err);
                    statusText.innerText = "üö´ Impossible d'acc√©der √† la cam√©ra.";
                });
        });

        function captureAndSend() {
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append("image", blob, "capture.jpg");
                formData.append("nom", nom);
                formData.append("prenom", prenom);

                fetch("/login", {
                    method: "POST",
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("R√©ponse r√©seau incorrecte");
                    }
                    return response.json();
                })
                .then(data => {
                    statusText.innerText = data.result;

                    if (data.authorized) {
                        statusText.innerText = "‚úÖ " + data.result;
                        setTimeout(() => {
                            window.location.href = "dashboard"; // page fictive
                        }, 1500);
                    } else {
                        statusText.innerText = "‚ùå " + data.result;
                        setTimeout(captureAndSend, 5000); // r√©essaie apr√®s 5s
                    }
                })
                .catch(err => {
                    console.error("Erreur d'envoi :", err);
                    statusText.innerText = "‚ùå Erreur lors de l'envoi de l'image.";
                });
            }, "image/jpeg");
        }
    </script>
</body>
</html>
